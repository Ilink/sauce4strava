#!/usr/bin/env python3

import json
import shutil
import subprocess

with open('manifest.json') as f:
    d = json.load(f)
    version = d['version']

with open('build.json') as f:
    d = json.load(f)
    commit = d['git_commit']


fname = f'sauce4strava-safari-{version}.zip'
build_dir = 'safari-app/Sauce for Strava™/DerivedData/Sauce for Strava™/Build/Products/Release/'
subprocess.check_call(['zip', '-ry', fname, 'Sauce for Strava™.app'], cwd=build_dir)

website_project = '../SauceLLC.github.io/'
website_dir = website_project + 'builds/safari/'

shutil.copyfile(build_dir + fname, website_dir + fname)

with open(website_dir + 'LATEST.json', 'w') as f:
    json.dump({
        "version": version,
        "commit": commit,
        "url": f'https://saucellc.io/builds/safari/{fname}'
    }, f)

subprocess.check_call(['git', 'commit', '-a', '-m', 'Safari release ' + version], cwd=website_project)
subprocess.check_call(['git', 'push'], cwd=website_project)
