<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <title>Safari Database Size Hack</title>
        <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet"/>
        <link rel="stylesheet" href="/css/ext/options.css"/>
        <script defer src="/src/ext/webext.js"></script>
        <script defer src="/src/common/base.js"></script>
        <script defer src="/src/common/base_init.js"></script>
        <script defer src="/src/common/ga.js"></script>
        <script defer src="/src/common/storage.js"></script>
        <script defer src="/src/ext/webkit_db_size_hack.js"></script>
        <style>
            footer .links {
                margin-top: 1em;
                display: flex;
                justify-content: center;
            }

            footer .links > a {
                padding: 0 0.5em;
            }

            section {
                max-width: 30rem;
            }

            form.alloc-settings {
                display: flex;
                flex-direction: column;
            }
        </style>
    </head>

    <body>
        <header>
            <img src="/images/logo_vert_120x320.png"/>
            <h2 class="title">Sauce for Strava<sup>TM</sup></h2>
            <h3 class="sub-title">Safari Database Size Hack</h3>
            <a class="dismiss popup-only"></a>
        </header>

        <main>
            <section>
                <p>This tool is <b>ONLY</b> needed for Safari users that intend to use the
                <a href="https://www.strava.com/sauce/performance" target="_blank" class="saucey">Sauce Performance</a>
                feature set.   Safari initially uses a very small quota for site (and extension) storage, which is insufficient for most Sauce users.  The only way to increase this storage quota is to actually use more space!  Furthermore, because Sauce runs as an extension in the background it doesn't work with this design choice.  Hence the reason of this hack!   This process works as follows...</p>
                <ol>
                    <li>A temporary storage database (IndexedDB) is created.</li>
                    <li>We start filling up the database with dummy data.</li>
                    <li>Eventually Safari will interrupt the process with a dialog asking you for permission to use more space.  This process may repeat several times until you reach the storage goals.</li>
                    <li>After the desired size is reached the temporary database is deleted.</li>
                    <li>Your disk space is restored but the storage quota remains increased so that Sauce may run happily in the future.</li>
                </ol>
                <p>The amount of space needed will vary from user to user but the controls below will help guide you.  Remember, this tool will <b>only temporarily use disk space</b> and Sauce will only be using the storage it needs.</p>
            </section>
            <section>
                <form class="alloc-settings">
                    <label>Expected synced athletes: <input type="number" min="1" max="100" value="1"/></label>
                    <div class="est-space">Estimated usage: <span class="usage"></span></div>
                    <label>Progress: <progress value="0"></progress></label>
                    <button name="start">Start allocating space</button>
                    <b><i>Remember to click "Allow" each time you're prompted.</i></b>
                </form>
            </section>
        </main>

        <footer>
            <div class="buttons">
                <a class="popup-only" href="options.html?popup"><button>Back</button></a>
                <a class="not-popup-only" href="options.html"><button>Back</button></a>
            </div>
            <div id="status"></div>
        </footer>
    </body>
</html>
